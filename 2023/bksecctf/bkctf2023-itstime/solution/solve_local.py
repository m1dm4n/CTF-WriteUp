# https://github.com/JuliaPoo/MT19937-Symbolic-Execution-and-Solver
import sys
import os
import time
sys.path.append('/mnt/d/code/Helper/MT19937/source')
# Import symbolic execution
from MT19937 import MT19937
from z3 import *

data = [318540552, 844958662, 3420023323, 377981430, 62342865, 206623833, 2706764486, 1138518605, 2560599208, 3265970255, 2916661253, 1440549138, 1216695480, 3788421118, 1679406716, 290810592, 2320566375, 3245028241, 2025551937, 3075037754, 755991156, 3976460779, 623574521, 287636452, 1915543043, 2316972118, 2570212933, 342827469, 1711255724, 3633735155, 874144699, 1796204549, 532429264, 2997959676, 1152902633, 2593321837, 3773819727, 554670719, 534913568, 3390285438, 2222727497, 1998729720, 1157186312, 70396943, 1554642942, 155941715, 726650606, 2431782768, 2838483669, 1861866267, 1925273491, 3155678502, 4161578584, 2339502756, 2107044980, 1138320809, 1076334792, 28185339, 1095512726, 3636841168, 1926737090, 4270140638, 4200870269, 2754137738, 3801761349, 4222792021, 1006637570, 2951281958, 2356758035, 366618454, 2550566450, 1381948629, 2555644232, 1586843032, 1394319227, 1569826986, 3953856138, 3333610243, 1378568044, 2799231318, 1194754625, 2740944415, 2472019694, 2229516190, 3461061856, 574331342, 1825013567, 536629799, 2551402100, 859704824, 1588703152, 359240584, 7104655, 889386644, 3189129449, 2856544132, 1269016562, 4021543538, 1835308632, 276425790, 523832765, 1320179792, 685999731, 341876915, 967573939, 1091073889, 2457998339, 1632769397, 1858574599, 2207177528, 3518166703, 2125081367, 3518332277, 3075187528, 2834429716, 1722557337, 3315567568, 2522987421, 1130053529, 2045004587, 2036117322, 532299786, 3218002673, 2879300390, 2342189258, 2997242727, 1621487412, 1956163035, 1700658606, 4157961038, 2392791743, 1706411050, 1794398539, 3183480052, 3434503835, 4264356384, 923153807, 1590030089, 3408185351, 3106328513, 1234819813, 2205697752, 2647971793, 3470684140, 3351902223, 173977320, 2764210716, 1257427907, 4178660656, 3081981921, 3270271579, 4117881372, 181664870, 871566500, 4030066406, 3233613700, 4020410805, 4022316884, 1427282282, 3718479701, 3877740703, 1982445089, 2071193540, 3592055967, 2983539772, 2169208596, 3918749888, 2056138707, 115017460, 3353855750, 2476438260, 2420917668, 3902972373, 4021998125, 103901522, 2921245374, 3700516748, 1202397203, 3703579549, 2071515506, 1644995833, 944659366, 3428658000, 3737053260, 1067365343, 1978944085, 3470305776, 1355188544, 1659915375, 3973544360, 1300722269, 1333915546, 2112884463, 3751274195, 3220969716, 3736533465, 1918775954, 3598899610, 1962444438, 3666587319, 4257075855, 1144669128, 210384497, 252888851, 3872554630, 3499448084, 3453934697, 535314511, 1375614412, 4040875372, 3221483551, 3157178319, 379749157, 1260862834, 1284727828, 102576420, 304072914, 2453151041, 1547630645, 538162719, 3256625675, 240338418, 1589618501, 3203853235, 1824449912, 2108602891, 21453553, 320881745, 1829601803, 499505701, 4285537883, 1270149010, 2957056866, 1064717560, 2041318280, 2267103949, 3814541811, 1503591821, 3171860354, 3714098420, 2612502336, 1005232767, 1861018343, 757291312, 3725500686, 361907290, 3038845358, 2856651529, 149395193, 1454251435, 1340215131, 867832757, 2047026610, 1507179443, 3772497053, 1421328831, 2787385049, 868710824, 2326665397, 2969460603, 1450027358, 2142687873, 3449216555, 961230380, 2703527616, 1185811082, 1873498116, 2955289356, 3337660852, 819626762, 282877171, 427251424, 1654168692, 2932822739, 3939299874, 3444457993, 2808429557, 543524346, 3024564172, 2712331013, 3618689893, 1990342901, 1560771302, 285586383, 1559113245, 1574962515, 3368310913, 3481366305, 837334717, 1914714969, 2447084710, 3340808711, 3656093854, 3000424717, 3773789185, 3334218706, 2711941526, 2891681216, 398733685, 2294013020, 2892835186, 1870123253, 1437886016, 3973233915, 1727956964, 3272724344, 3672046426, 3973648900, 3824160649, 34866635, 4292938515, 4203750169, 2364327579, 216132424, 1034367567, 4082596965, 3238097715, 2108916435, 2964108421, 2598491501, 800648499, 326914744, 2254282519, 2263064310, 260197511, 1354392399, 2946927470, 3530726230, 187770020, 3533399782, 3310979144, 551719840, 2259872426, 3841864238, 1199470399, 901138139, 630782791, 1984393688, 3792155639, 1496365659, 3271410345, 1652374718, 516478355, 1900640218, 2841154422, 2526362879, 2720666263, 1495704957, 4147270082, 1293142329, 1417157973, 3983812911, 3409791814, 3296956211, 1078144335, 3693112179, 1469747274, 3359978207, 758726507, 2686859338, 570679857, 2286237167, 4225766056, 857332362, 1073989740, 94482179, 3990826133, 1658937412, 1929140453, 608235328, 2163671137, 2273568399, 3996659049, 2953927816, 2939940584, 1523149318, 278180834, 490670024, 742763521, 2199197539, 389552756, 579429047, 1723557700, 1375238344, 3600561609, 718874359, 1961823618, 1936475527, 1741932706, 4070058327, 3504448397, 1423518310, 4051963275, 3604454523, 3360268690, 861688646, 1992101789, 3897034255, 1300033641, 3279739672, 1720699729, 1049641376, 3036810537, 1419472101, 3471169393, 2943033265, 3114014034, 1350816608, 982426601, 1215190820, 4225243577, 4282560784, 3612257909, 871751018, 1653660890, 2323573256, 1038060963, 3776545114, 371341476, 2156263193, 3656029239, 1881667183, 2672406514, 2703644076, 466255037, 2616237109, 805509130, 2504043541, 1283376440, 2981917651, 212236855, 57371156, 2648002339, 632902148, 3826933997, 942994270, 3240911633, 1516290067, 4264610778, 533963488, 2583560752, 664866158, 2247437902, 2283283352, 438698383, 2163182821, 3275386394, 2304733708, 3206169556, 585611170, 1052068150, 2941147328, 2912780938, 2528661568, 2704046637, 772080874, 1607910121, 3151773141, 3535885501, 744213090, 68512410, 1311360765, 3818718451, 914753431, 61773886, 2556004951, 837993943, 3210444507, 262770996, 3313571124, 1162074971, 1771009427, 2779976650, 3117874681, 4105673273, 3343091660, 4091198898, 1936578507, 1445396032, 826616487, 195275863, 3053044720, 1255558759, 464860956, 3390460149, 3843233599, 2854110892, 362791719, 851400678, 1644209596, 2519277921, 532478360, 2773346176, 2245223382, 657970891, 1956094809, 220704516, 4201540337, 3886718398, 286566917, 81917539, 1463340213, 3038018896, 725650456, 543891417, 712463410, 1505399123, 1230172733, 1582456571, 949463929, 3198115260, 1209819449, 3318087284, 2473302998, 1645757914, 166575046, 809367490, 4237513893, 2255284278, 2364580891, 1790025202, 3332734884, 4288438444, 3656401378, 1784621315, 3762663456, 746475084, 2359344156, 1728397189, 3974899020, 521373141, 3866708326, 84770968, 403313048, 4017860595, 3569763009, 4260981949, 1325262500, 794004551, 2381475704, 1214160188, 2404692408, 3696683719, 1393889593, 1847065731, 3413321551, 2830062643, 1618496868, 2834062442, 4234021645, 767496314, 1624540748, 2405153395, 1952184835, 1948911971, 2301436929, 361331681, 368714598, 2402725358, 4274585708, 2368776631, 3800204637, 2261754750, 2724968737, 2267288448, 2980699205, 246577411, 2709889349, 899928935, 3472749601, 842614493, 3852836813, 1203426970, 511288144, 126987003, 40027065, 1350259555, 990430283, 3642282429, 830519965, 2941514084, 1837661219, 1035883111, 2108102322, 1115324257, 3026396836, 2158698311, 105368814, 1868380024, 1155405268, 3273476850, 2079595606, 34744027, 4294187636, 432604162, 3911061497, 2413030264, 2914005239, 2370581001, 3595840984, 252924415, 1280441039, 3754248979, 1739213249, 3637061008, 2287065952, 1586290231, 217968917, 3250350294, 3414279289, 3837046120, 4102435918, 2581217410, 1453174089, 1551708349, 2266727345, 1187934792, 2279065414, 3040518144, 3983505729, 1138058448, 1188345396, 994133479, 3649318472]
_init = [19650218, 2194844435, 874550967, 1417962806, 719805879, 2188372024, 721660136, 1814940559, 2833403150, 3889680837, 1003665704, 1330738387, 2892331238, 3489052161, 3855278296, 3311200630, 1422571577, 2585306665, 2882769417, 2783805802, 4207719964, 2400416080, 2341377904, 2590753297, 3924081815, 1211472509, 3057012486, 3436335279, 551149560, 1318655221, 1900533858, 3537525294, 2107812065, 3148644481, 594136785, 1814262168, 1224061569, 653651109, 254650943, 2832785922, 3699583528, 2088609312, 3529585711, 41492871, 2876012911, 4240588078, 1402615791, 1934126869, 3096545044, 2890863071, 80499043, 970921794, 3007610686, 750866145, 799115259, 3629971774, 2864380489, 3888374480, 2087741561, 3146346387, 3269762417, 2727485495, 2488668711, 2964190680, 2116659522, 4141458096, 3537107937, 3667677805, 2429248426, 2452306317, 3015982257, 499957222, 2360410630, 4194693085, 147288288, 3359074475, 1635136148, 4073107990, 3628367767, 3898116531, 275612352, 2842514961, 3115851985, 3103448722, 302309156, 22171017, 2075519075, 3671007489, 3949991970, 1963601502, 4167967445, 804406473, 1055110313, 3894654986, 2278780139, 34711884, 4121261916, 3468881884, 2287991389, 393453278, 548699130, 1499706375, 332872900, 1556864443, 1043137738, 4174970395, 1614747618, 669116410, 1897615374, 3255278936, 1370736725, 1550777747, 1685794058, 1862314184, 2400528575, 2672900100, 1647333586, 3524644532, 1765506473, 2857335743, 3636393737, 2932986219, 1203228647, 1628511289, 3647085204, 2987412752, 2905279128, 2631768385, 4014428911, 1727529885, 1124854030, 2262104686, 2499713312, 2421398767, 4134715143, 2358935835, 1002066021, 340444514, 3268366900, 1112268606, 1897974631, 3331577291, 2922602614, 3423543891, 1267030560, 2344564886, 1942259446, 3179572998, 1573187880, 1205933762, 3025229445, 4246102746, 346693941, 2002220930, 1829519945, 3309743875, 1904872348, 955816590, 2796353700, 668528669, 2648785169, 2704726048, 893089804, 738773343, 2832484895, 2050343702, 104744889, 3439545764, 980222603, 422274176, 3865519914, 2026267864, 539814729, 4137805178, 1140607595, 2537690753, 3971218783, 1931293181, 3089667358, 1133695167, 399772074, 3682192071, 4293649418, 1029228868, 3902327948, 1974090788, 3344730195, 2795804747, 3396216457, 366677807, 416687433, 930072460, 901228284, 1521860141, 3484259358, 478803252, 3138556488, 4137898487, 3807832586, 3773310804, 3221624091, 3076008769, 4156878137, 406561453, 3897607181, 623564883, 2247148685, 1696011322, 2911604503, 3979653402, 742342831, 3881512158, 2282092805, 2681274264, 3681829528, 46152446, 3126539534, 3635632789, 1012335624, 3686064131, 2587648220, 2008745587, 2556071384, 1788453345, 861781568, 2727104545, 758340017, 1880693944, 2136364769, 1370367813, 798286522, 506003017, 2520802485, 2991500316, 3489134272, 3275208410, 1640252809, 3797759893, 4271912220, 3111882026, 140581304, 2568658569, 2686841033, 3059852298, 293994524, 1890650113, 1797269750, 3428669802, 1401714789, 2643788909, 3727894469, 2833360921, 1622853283, 3832221927, 277065458, 3711010937, 4192871202, 3356722694, 680496635, 2574997514, 1476265004, 3232676806, 3318710975, 4210635059, 4159903992, 2116300560, 2532158399, 718792604, 2539969944, 3164133583, 2649636591, 2200349072, 2851998122, 670873689, 2613796143, 3562264788, 1174445287, 1149173203, 2225964784, 4266377361, 3119455410, 1518371465, 1816545474, 2516586762, 240910660, 2681595121, 1301176317, 3127753611, 862342957, 771183330, 438085196, 1046497567, 922186079, 1222939296, 51184555, 1757804190, 426665187, 2730510776, 2573705612, 1312406577, 667742236, 3239950393, 2582034960, 3759737929, 1601926242, 2947737408, 975540284, 1285948639, 3761027786, 1226457986, 34782949, 2916146832, 142734034, 569716755, 4042990521, 3947471773, 1575951506, 3517313596, 3100986137, 2199197158, 3376719924, 4087139828, 3705107125, 1482533137, 1541227668, 1678953742, 2056318769, 3045003063, 1622629937, 487578169, 4137196231, 3764647071, 2241527512, 2558474063, 1038354351, 2094837850, 2481932343, 3229539130, 3756851151, 1006180559, 4181103103, 3565909441, 2371373280, 1493415041, 160348120, 1285104017, 3595587370, 4264242568, 1161124915, 2042766103, 737713932, 3481808155, 478389208, 1300643225, 1007986266, 1168231653, 3652705112, 2909421388, 3924670764, 1731016690, 4084014919, 4205099837, 1373900512, 2937538864, 2730075174, 957417377, 3258199283, 87174175, 792789163, 2527971304, 2716998340, 3091367825, 97659251, 1782441684, 919015551, 735476370, 87326482, 926205331, 1888657273, 3715638227, 1715499660, 1922410526, 4175228089, 1525608673, 3578587616, 2042086160, 3730509879, 3607443975, 3879209240, 3652717612, 2372597521, 3471943430, 2765853569, 3643232056, 3297105617, 2692883557, 1805942063, 1394934451, 3337180104, 1181922214, 2331394419, 306465830, 3736887952, 1729663122, 3390355091, 2379159653, 3851731257, 4021176185, 1079541434, 433656928, 1831627642, 2892512290, 4063025724, 406246264, 1293199350, 1120564498, 3926678815, 1350089133, 4273098366, 3385122292, 993379095, 725502136, 25504318, 752278045, 3729298457, 2392480235, 2657233815, 320925812, 2950230896, 989728679, 506301841, 1404204260, 1413065993, 865242585, 866785615, 1859142878, 589268143, 775553472, 1410495094, 1607063978, 3888932143, 704411669, 3513884419, 3370826939, 2896358996, 439226283, 2352722741, 1626809714, 246502175, 189424636, 1337937966, 3719088974, 4178799653, 2794717891, 1831166187, 1862432793, 2263235392, 3847861459, 802662362, 3621709005, 2634319122, 3245216029, 1466421412, 1528864744, 349292989, 3152395874, 3374677426, 2279952808, 1238578150, 107682552, 913857966, 3747681661, 3560958606, 3617063034, 1988620951, 1854864649, 1862999556, 2962654934, 1498851202, 2003448718, 2942754891, 798789550, 3882536840, 3338815162, 3066948065, 2057094004, 4171611151, 4284063395, 2325690120, 2659914459, 165909127, 2783186990, 2161504072, 343671839, 2751150377, 3621950182, 222528329, 3219381950, 238911006, 2710753737, 2982111755, 1115859074, 156211365, 228231184, 2302165064, 933165355, 4181545713, 2201173365, 291303663, 19134280, 3581811046, 68817880, 1037069880, 2445243929, 2507869609, 1468655994, 2646143627, 2709652242, 559859542, 2657856757, 248278651, 656698256, 2682159578, 3542996035, 2775252812, 1761180115, 3646714856, 2330951878, 834843492, 3951905925, 744286448, 3621804227, 2822882772, 1168938371, 3349647456, 672527398, 1163635478, 3445281068, 722448549, 3543924788, 2823456463, 1931863550, 2483173049, 4148604134, 3081487737, 2916138664, 940193076, 4142650279, 2563327448, 3737140007, 2407111514, 243557343, 1657192483, 3995730323, 1012445178, 2365602253, 2830079959, 2287658550, 2893719730, 2373631903, 4215513121, 189686171, 2003138393, 3410898923, 1020530876, 1103312993, 1976606742, 899447370, 1949555562, 3167671920, 595304244, 1919198655, 2929333298, 619161901, 623498751, 2063591130, 763251111, 4291719204, 3951567013, 2998385089, 758818611, 1375945828, 2510752543, 4188334520, 121785359, 3225750324, 1354685949, 1643999927, 911976986, 518523023, 3993561529, 2326708913, 336174575, 853096604, 2873283550, 4022490143, 3010604384, 2080594943, 1702902668, 3360749048, 4184957279, 2421794725, 4155016765, 3104188113, 1576615579, 604774175, 2739462297, 4096823942, 1932918233, 1779286169, 2544260698, 1430072091, 2196303270, 4237199385, 2613550760, 1481676153, 2920297152, 2463881971, 1098865791, 2939219489, 2494804283, 3108728554, 1635052534, 2905164258]

# Recover state after self.random_seed()
cur_time = time.time()
print("Recover state took: ", end='')
rng_clone = MT19937(state_from_data = (data, 32))
# just in case i overrun some values
while True:
    if rng_clone.state[0] == 2**31:
        break
    rng_clone.reverse_states(1)
state_after = rng_clone.state
print(f"{time.time() - cur_time:0.5f}s")

# Recover seed array
# https://github.com/Chrstm/Mersenne-Twister-PRNG/blob/master/mtrandom.py#L99
print("Recover seed took: ", end='')
state_current = [BitVecVal(a, 32) for a in _init]
init_key = [BitVec(f'x_{i}', 32)  for i in range(5)]
N = 624
i, j = 1, 0
for k in range(624, 0, -1):
    state_current[i] = ((state_current[i] ^ ((state_current[i - 1] ^ LShR(state_current[i - 1], 30)) * BitVecVal(1664525, 32))) + init_key[j] + j)
    i += 1
    j += 1
    if i >= N:
        state_current[0] = state_current[N - 1]
        i = 1
    if j >= 5:
        j = 0
for k in range(N - 1, 0, -1):
    state_current[i] = ((state_current[i] ^ ((state_current[i - 1] ^ LShR(state_current[i - 1], 30)) * BitVecVal(1566083941, 32))) - i)
    i += 1
    if i >= N:
        state_current[0] = state_current[N - 1]
        i = 1
state_current[0] = 0x80000000


# Get time
S = Solver()
for a, b in zip(state_current[1:], state_after[1:]):
    S.add(a == b)
if S.check() == sat:
    model = S.model()
    state = list(map(lambda x: model[x].as_long(), init_key))
    print(f"{time.time() - cur_time:0.5f}s")
    print("initkey =", state)
else:
    print("Non")
